WITH
 revenue_usd AS (
 SELECT
   s.date,
   SUM(p.price) AS revenue
 FROM
   `DA.order` o
 JOIN
   `DA.product` p
 ON
   o.item_id = p.item_id
 JOIN
   `DA.session` s
 ON
   o.ga_session_id = s.ga_session_id
 GROUP BY
   s.date ),
   email_metrics AS (
 SELECT
   DATE_ADD(s.date, INTERVAL ems.sent_date DAY) AS sent_date,
   COUNT(DISTINCT ems.id_message) AS sent_msg,
   COUNT(DISTINCT eo.id_message) AS open_msg,
   COUNT(DISTINCT ev.id_message) AS click_msg
 FROM
   `DA.email_sent` ems
 JOIN
   `DA.account_session` acs
 ON
   ems.id_account = acs.account_id
 JOIN
   `DA.session` s
 ON
   acs.ga_session_id = s.ga_session_id
 LEFT JOIN
   `DA.email_open` eo
 ON
   ems.id_message = eo.id_message
 LEFT JOIN
   `DA.email_visit` ev
 ON
   ems.id_message = ev.id_message
 GROUP BY
   DATE_ADD(s.date, INTERVAL ems.sent_date DAY) ),
   registrations AS (
 SELECT
   s.date,
   COUNT(ac.account_id) AS account_cnt
 FROM
   `DA.account_session` ac
 JOIN
   `DA.session` s
 ON
   ac.ga_session_id = s.ga_session_id
 GROUP BY
   s.date ),
   final AS (
 SELECT
   date,
   revenue,
   0 AS cost,
   0 sent_msg,
   0 AS open_msg,
   0 AS click_msg,
   0 AS account_cnt
 FROM
   revenue_usd
 UNION ALL
 SELECT
   date,
   0 AS revenue,
   cost,
   0 sent_msg,
   0 AS open_msg,
   0 AS click_msg,
   0 AS account_cnt
 FROM
   `DA.paid_search_cost`
 UNION ALL
 SELECT
   sent_date,
   0 AS revenue,
   0 AS cost,
   sent_msg,
   open_msg,
   click_msg,
   0 AS account_cnt
 FROM
   email_metrics
 UNION ALL
 SELECT
   date,
   0 AS revenue,
   0 AS cost,
   0 AS sent_msg,
   0 AS open_msg,
   0 AS click_msg,
   account_cnt
 FROM
   registrations )
   SELECT
 
   date,
 SUM(revenue) AS revenue,
 SUM(cost) AS cost,
 SUM(sent_msg) AS sent_msg,

 SUM (click_msg) AS click_msg,
  SUM(open_msg) AS open_msg,
 SUM(account_cnt) AS registrations
FROM
 final
GROUP BY
 date
